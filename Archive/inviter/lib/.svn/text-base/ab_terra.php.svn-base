<?php
/********************************************************************************
DO NOT EDIT THIS FILE!

Terra.es/ole.com contacts importer

You may not reprint or redistribute this code without permission from Octazen Solutions.

Copyright 2009 Octazen Solutions. All Rights Reserved
WWW: http://www.octazen.com
********************************************************************************/
//include_once(dirname(__FILE__).'/abimporter.php');
if (!defined('__ABI')) die('Please include abi.php to use this importer!');

global $_OZ_SERVICES;
$_OZ_SERVICES['terra'] = array('type'=>'abi', 'label'=>'Terra.es', 'class'=>'TerraImporter');

/////////////////////////////////////////////////////////////////////////////////////////
//TerraImporter
/////////////////////////////////////////////////////////////////////////////////////////
//@api
class TerraImporter extends WebRequestor {

	var $REDIRECT_REGEX = "/document\\.cookie=\"([^\"]*)\";.*?document\\.location='([^'\"]*)';/ims";
	var $T_REGEX = "/&t=([^&\"']*)/ims";

	var $login;
	var $domain;
	var $t;
	var $homeuri;

	//@api
	function getInfo () {
		return array('id'=>'terra.es');
	}

	//@api
	function login ($loginemail, $password) {
		$this->t = NULL;
		
		$parts = $this->getEmailParts ($loginemail);
		$this->login = $parts[0];
		$this->domain = $parts[1];

		$this->setOwnerEmail($loginemail);
		oz_set_domain($parts[1]);

		$form = new HttpForm;
		$form->action = "https://correo.terra.es/fcgi/perl/loginCGI.cgi";
		$form->addField("usera", $this->login);
		$form->addField("user", $this->login + "." + $this->domain);
		$form->addField("dominio", $this->domain);
		$form->addField("To", "");
		$form->addField("Subject", "");
		$form->addField("URIRetorno", "");
		$form->addField("password", $password);
		$form->addField("entrar.x", "79");
		$form->addField("entrar.y", "9");
		$html = $this->postForm($form);
		if (strpos($html,'Usuario/password incorrectos')!==FALSE || strpos($html,'alert(')!==FALSE) {
			$this->close();
			return abi_set_error(_ABI_AUTHENTICATION_FAILED,'Bad user name or password');
		}

		// Add cookie and get redirect location
		if (preg_match($this->REDIRECT_REGEX,$html,$matches)==0) {
			$this->close();
			return abi_set_error(_ABI_FAILED,'Cannot find redirect location');
		}
		$cookie = $matches[1];
		$this->homeuri = $matches[2];
		$this->cookiejar->addCookie(new OzCookie($cookie,'http://terra.es'));
		if (preg_match($this->T_REGEX,$html,$matches)==0) {
			$this->close();
			return abi_set_error(_ABI_FAILED,'Cannot find t');
		}
		$this->t = $matches[1];

		return abi_set_success();
	}

	//@api
	function logout() {
		if ($this->t!==NULL) {
			$this->httpGet("/cp/ps/Main/logout/Logout?d=".$this->domain."&u=".$this->login."&t=".$this->t);
			$this->t = NULL;
		}
	}

	//@api
	function fetchContacts ($loginemail, $password) {
	 
		$res = $this->login($loginemail,$password);
		if ($res!=_ABI_SUCCESS) return $res;

		$url = "/cp/ps/PSPab/Downloader?d=".$this->domain."&u=".urlencode($this->login)."&t=".$this->t."&dhid=contactsDownloader";
		$url = $this->makeAbsolute($this->homeuri, $url);
		
		$form = new HttpForm;
		$form->action = $url;
		$form->addField("exportbook", "PAB://".$this->domain."/".$this->login."/main");
		$form->addField("fileFormat", "CSV");
		$form->addField("charset", "UTF8");
		$form->addField("Button", "Exportar contactos");
		$html = $this->postForm($form);

		////////////////////////////////////////////////////
		//Read header and detect fields
		////////////////////////////////////////////////////
		$reader = new OzCsvReader($html);
		$cols = $reader->nextRow();
		if ($cols===NULL) {
			return abi_set_error(_ABI_FAILED,'Unexpected CSV. Missing header row.');
		}
		$fnameIndex = 1;
		$mnameIndex = 2;
		$lnameIndex = 3;
		$emailIndices = array(6,7,8);

		// //////////////////////////////////////////////////
		// Read rows
		// //////////////////////////////////////////////////
		$al = array();
		while (true) {
			$cols = $reader->nextRow();
			if ($cols===null) break;
			foreach ($emailIndices as $emailIndex) {
				$name = null;
				$fname = '';
				$mname = '';
				$lname = '';
				$n = count($cols);
				if ($n<=$emailIndex) continue;
				$email = $cols[$emailIndex];
				if ($fnameIndex != -1 && $fnameIndex<$n) $fname = $cols[$fnameIndex];
				if ($mnameIndex != -1 && $mnameIndex<$n) $mname = $cols[$mnameIndex];
				if ($lnameIndex != -1 && $lnameIndex<$n) $lname = $cols[$lnameIndex];
				if (empty($name)) {
					if (!empty($fname) || !empty($mname) || !empty($lname)) {
						$name = $fname.' '.$mname.' '.$lname;
						$name = oz_reduce_whitespace($name);
					}
				}
				if (!empty($email) && abi_valid_email($email)) {
					$contact = new Contact($name,$email);
					$al[] = $contact;
				}
			}
		}
		return $al;

	}


}


//terra.es (release date: 15 June 2008)
global $_DOMAIN_IMPORTERS;
$_DOMAIN_IMPORTERS["terra.es"] = 'TerraImporter';
$_DOMAIN_IMPORTERS["ole.com"] = 'TerraImporter';
$_DOMAIN_IMPORTERS["tudominio.com"] = 'TerraImporter';
$_DOMAIN_IMPORTERS["tudominio.es"] = 'TerraImporter';
$_DOMAIN_IMPORTERS["tudominio.org"] = 'TerraImporter';
